name: Full Validation + Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform fmt check
        run: |
          cd terraform/web-server
          terraform fmt -check

      - name: Terraform init
        run: |
          cd terraform/web-server
          terraform init

      - name: Terraform validate
        run: |
          cd terraform/web-server
          terraform validate

      - name: Install tfsec (Terraform security scanner)
        run: |
          curl -sSfL https://raw.githubusercontent.com/aquasecurity/tfsec/master/install.sh | sh -s -- -b $HOME/.local/bin

      - name: Run tfsec
        run: |
          cd terraform/web-server
          $HOME/.local/bin/tfsec .

  ansible:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Ansible and ansible-lint
        run: |
          sudo apt update
          sudo apt install -y ansible
          pip3 install ansible-lint

      - name: Ansible syntax check
        run: |
          cd ansible/system-roles
          ansible-playbook --syntax-check *.yml

      - name: Run ansible-lint
        run: |
          cd ansible/system-roles
          ansible-lint *.yml
